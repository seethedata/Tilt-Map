<!DOCTYPE html>
<html>
<head>
<link href="css/bootstrap.min.css" rel="stylesheet"/>
<script type='text/javascript' src='js/jquery.min.js'></script>
<script type='text/javascript' src='js/d3.min.js'></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>	
<script type='text/javascript' src='js/bootstrap.min.js'></script>
<script language="javascript">

	var regions =["Africa","Asia","Europe","North America","Oceania","South America"];

	var points = [{"longitude":-75.5,"latitude": 40.1,"TiltFB":10},{"longitude":0,"latitude":0,"TiltFB":4}];

	var point=[{"longitude": -75.30670565646393, "timestamp": 20160705195216292, "TiltFB": 10.05603305233052166, "TiltLR": -0.3360182733504824, "altitude": 36.665042877197266, "OS": "iOS", "devid": "cce2-fc0d", "Direction": 40.65654021985403, "latitude": 40.067854982140965}];

	/* This works 
	var testPoint={"data" : [{"longitude": -75.30670565646393, "timestamp": 20160705195216292, "TiltFB": 10.05603305233052166, "TiltLR": -0.3360182733504824, "altitude": 36.665042877197266, "OS": "iOS", "devid": "cce2-fc0d", "Direction": 40.65654021985403, "latitude": 40.067854982140965}],"instance": ["server:8080:88"],"min_score": 0,"timestamp": 20160706124512964};
	*/

	
	/* This works  */
	var testPoint=[{"longitude": -75.30670565646393, "timestamp": 20160705195216292, "TiltFB": 10.05603305233052166, "TiltLR": -0.3360182733504824, "altitude": 36.665042877197266, "OS": "iOS", "devid": "cce2-fc0d", "Direction": 40.65654021985403, "latitude": 40.067854982140965}];
	
	
	/* This doesn't. The only difference is the lack of starting and ending brackets. The data passed to D3 has to be an array.
	var testPoint={"longitude": -75.30670565646393, "timestamp": 20160705195216292, "TiltFB": 10.05603305233052166, "TiltLR": -0.3360182733504824, "altitude": 36.665042877197266, "OS": "iOS", "devid": "cce2-fc0d", "Direction": 40.65654021985403, "latitude": 40.067854982140965};
	*/
	


	var active = d3.select(null);

	var dataURL='http://tilt.cfapps.io/safe_dump?min_score=0&latest=1';
	var svg;
	var projection;
	var path;
	var width = 960;
	var height = 500;	
	var min_ts=0;


	function initialize() {
		projection=d3.geoMercator();

					
		path=d3.geoPath()
			.projection(projection);

		svg = d3.select("#tiltMap").append("svg")
		.attr("width", width)
		.attr("height", height);
		
		d3.json("countryData/world.json", function(error, world) {
			if (error) return console.error(error);
			var subunits=topojson.feature(world, world.objects.subunits);
			
			for (var i=0, len=regions.length;i < len; i++) {
				g=svg.append("g").attr("id",regions[i]);
				
				g.selectAll(".subunit")
				.data(topojson.feature(world, world.objects.subunits).features.filter(function(d) { return d.properties.continent==regions[i];}))
				.enter()
					.append("path")
					.attr("class", function(d) {return "subunit " + d.id;})
					.attr("d",path)
					/*.on("click", clicked);*/
			
				
				if (regions[i] == "North America") {
					g.append("path")
					.datum(topojson.mesh(world, world.objects.states, function(a,b) {return a != b && a.id == "USA";}))
					.attr("class", "state-boundary")
					.attr("stroke", "black")
					.attr("fill","none")
					.attr("d", path);
				}
			}
			
			g.append("path")
					.datum(topojson.mesh(world, world.objects.subunits))
					.attr("class", "subunit-boundary")
					.attr("stroke", "black")
					.attr("fill","none")
					.attr("d", path);
		});
	}

	function getDeviceData() {
		d3.json(dataURL, function plotDevices(error, devData) {
			if (error) return console.warn(error);
			devices=d3.select("svg").selectAll(".device")
					.data(devData.data);
			devices.transition()
					.attr("transform", function(d) {var jsonData=JSON.parse(d); return "translate(" + projection([jsonData.longitude,jsonData.latitude]) + ")";})
					.attr("r",function(d) {var jsonData=JSON.parse(d);return Math.sqrt(Math.abs(jsonData.TiltFB));})
					/*.attr("fill",function(d) {var jsonData=JSON.parse(d);return jsonData.TiltFB > 0 ? "#000000" : "#FF0000";});*/
					.attr("fill",function(d) {var jsonData=JSON.parse(d);return getColor(jsonData.TiltFB);});

			
			devices.exit().remove();		
				
			devices.enter()
				.append("circle")
				.attr("class","device");
			});
	}
		


	setInterval(function(){getDeviceData()},500);

	function getColor(val) {
		var color;
		if(val <= -80) {
			color="#FF0000";
		} else if (val > -80 && val <= -60) {
			color="#FFA500";
		}else if ( val  > -60 && val <+ -10) {
			color="#006400";
		} else if (val > -10 && val <= 40) {
			color="#0000FF";
		} else if (val > 40 && val <= 60) {
			color="#006400";
		} else if (val > 60 && val <= 80) {
			color="#FFA500";
		} else if (val > 80) {
			color="#FF0000";
		}
		return color;
	}
/*	function clicked(d) {
	  if (active.node() === this) return reset();
	  active.classed("active", false);
	  active = d3.select(this).classed("active", true);
	  var bounds = path.bounds(d),
		  dx = bounds[1][0] - bounds[0][0],
		  dy = bounds[1][1] - bounds[0][1],
		  x = (bounds[0][0] + bounds[1][0]) / 2,
		  y = (bounds[0][1] + bounds[1][1]) / 2,
		  scale = .9 / Math.max(dx / width, dy / height),
		  translate = [width / 2 - scale * x, height / 2 - scale * y];


	  g.transition()
		  .duration(750)
		  .style("stroke-width", 1.5 / scale + "px")
		  .attr("transform", "translate(" + translate + ")scale(" + scale + ")");
	}

	function reset() {
	  active.classed("active", false);
	  active = d3.select(null);

		var g=d3.select("g");
		  g.transition()
			  .duration(750)
			  .style("stroke-width", "1.5px")
			  .attr("transform", "");
	}*/


</script>
<style>
.subunit { fill: #ddd;}


}


</style>
</head>
<body>
	<nav class="navbar navbar-inverse">
		<div class="container-fluid">
			<div class="navbar-header">
			  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			  </button>
			  <a class="navbar-brand" href="#">Tilt Visualization</a>
			  
			</div>
			<img class="col-xs-3" src="images/federation-bar.png"/>
			<div id="navbar" class="navbar-collapse collapse">

			  <ul class="nav navbar-nav navbar-right">
				<li><a onClick='loadViz("Pitch")'><span class="glyphicon glyphicon glyphicon-sort nav-glyph" aria-hidden="true"></span> Pitch</a></li>
				<li class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
						<span class="glyphicon glyphicon-globe nav-glyph" aria-hidden="true"></span> 
						Location
						</a>
					<ul class="dropdown-menu" role="menu" id="mapMenu">
					<script>
					d3.select("#mapMenu").selectAll("li")
						.data(regions)
						.enter()
						.append("li")
							.append("a")
							.attr("role","menuitem")
							.attr("onClick", function(d) {return "focusMap('" + d + "')";} )
							.text(function (d) {return d;});
					</script>
					</ul>
				</li>
			  </ul>
			</div>
		  </div>
    </nav>
	<div class="container-fluid" id="mainScreen">
		<div id='tiltMap' class="row col-xs-12"></div>
	</div>
	<script>
	window.onload=initialize();
	</script>
	<link href="css/tilt-map.css" rel="stylesheet"/>
</body>
</html>

