<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
	<style>

	.line {
	  fill: none;
	  stroke: steelblue;
	  stroke-width: 1.5px;
	}


	</style>
	<script>
	var regions =["Africa","Asia","Europe","North America","Oceania","South America"];

	function loadPage(url) {
		window.location.href=url;
	}

	</script>
	<script src="js/d3.v4.min.js"></script>
	<link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
	<nav class="navbar navbar-inverse">
			<div class="container-fluid">
				<div class="navbar-header">
				  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				  </button>
				  <a class="navbar-brand" href="#">Tilt Visualization</a>
				  
				</div>
				<img class="col-xs-5" id="federationLogo" src="images/federation-bar.png"/>
				<div id="navbar" class="navbar-collapse collapse">

				  <ul class="nav navbar-nav navbar-right">
					<li>
						<a onClick='loadPage("index.html");'>
							<span class="glyphicon glyphicon-sort nav-glyph" aria-hidden="true"></span> 
							Pitch
						</a>
					</li>
					<li>
						<a onClick='loadPage("customerService.html");'>
							<span class="glyphicon glyphicon-user nav-glyph" aria-hidden="true"></span> 
							Service
						</a>
					</li>
					<li>
						<a onClick='loadPage("trucking.html");'>
							<span class="glyphicon glyphicon-random nav-glyph" aria-hidden="true"></span> 
							Logistics
						</a>
					</li>
					<li class="dropdown">
						<a class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
							<span class="glyphicon glyphicon-globe nav-glyph" aria-hidden="true"></span> 
							Location
							</a>
						<ul class="dropdown-menu" role="menu" id="mapMenu">
						<script>
						d3.select("#mapMenu").selectAll("li")
							.data(regions)
							.enter()
							.append("li")
								.append("a")
								.attr("role","menuitem")
								.attr("onClick", 'loadPage("latlong.html");')
								.text(function (d) {return d;});
						</script>
						</ul>
					</li>
				  </ul>
				</div>
			  </div>
		</nav>
	<div class="container-fluid">
		<div class="row">
			<h1 class="text-center">http://tilt.cfapps.io</h1>
		</div>
		<div id="graphs" class="row">
		</div>
	</div>
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>

	<script>
	var tiltAPI="http://tilt.cfapps.io/safe_dump?";
	var min_ts=0;
	var refreshInterval=100; // in milliseconds
	var sampleWidth=30000 / refreshInterval; // 30 seconds of graphs (30000 milliseconds broken up into refreshInterval number of points)


	var margin = {top: 20, right: 20, bottom: 20, left: 40},
		width = 380- margin.left - margin.right,
		height = 166 - margin.top - margin.bottom;

		
	var allData={};

	var x = d3.scaleLinear()
		.domain([0, sampleWidth - 1])
		.range([0, width]);

	var y = d3.scaleLinear()
		.domain([-180, 180])
		.range([height, 0]);

	var line = d3.line()
		.x(function(d, i) {return x(i); })
		.y(function(d) {return y(d);});




	function updateGraphs() {
		var url=tiltAPI + "min_score="+min_ts + "&latest=1";
		d3.json(url, function plotDevices(error, devData) {
			if (error) return console.warn(error);
			min_ts=devData.timestamp;
		
			var nextData=devData.data;	
			var activeDevices={};
			for (var i=0; i < nextData.length ; i++)  {	
			
				var j=JSON.parse(nextData[i].replace(/"{/g,"{").replace(/}"/g,"}").replace(/\\"/g,"\""));
				var activeDevice=false;	
				if(allData.hasOwnProperty(j.devid)) {

					// Update existing devices
					allData[j.devid].push(j.TiltFB);
					activeDevices[j.devid]=true;					
				} else {
					// Add new devices

					allData[j.devid]=[0,j.TiltFB];
					activeDevices[j.devid]=true;
				}
				
				// Keep sample window the correct size
				if (allData[j.devid].length > sampleWidth) {
					allData[j.devid].shift();
				}
			}
			
			// Remove inactive devices
			for (var device in allData) {
				if (! activeDevices.hasOwnProperty(device)) {
					delete allData[device];
				}
			}
			
			var svg=d3.select("#graphs").selectAll(".graph").data(Object.keys(allData),function(d) {return d;} );

			var groups=svg.enter()
				.append("div")
				.attr("id",function(d) {return d;})
				.attr("class","graph col-lg-4")
				.append("svg")
					.attr("width",380)
					.attr("height", 166)
						.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		
			groups
				.append("g")
					.attr("class", "axis axis--y")
					.call(d3.axisLeft(y));
					
			groups
				.append("g")
				/*.attr("clip-path", "url(#clip)")
				.attr("id","clip-path")*/
				.append("path")
						.attr("class", "line")
						.attr("id",function(d) { return "lineFor-" + d;});
			
			groups
				.append("text")
					.text(function(d) {return d;})
						.attr("transform","translate(0,-5)");
						
			svg.exit().remove();
			

			for (var device in allData) {
				var thisLine=d3.select("#lineFor-" + device).datum(allData[device]);
				thisLine
					.attr("d", line)
					.attr("transform", null)
					.transition()
						.duration(500)
						.ease(d3.easeLinear);
					
				  // Slide it to the left.
				 thisLine.selectAll(".line").transition()
					  .attr("transform", "translate(" + x(-1) + ",0)");
			}

		});
	}

	setInterval(updateGraphs,refreshInterval);

	</script>
</body>
</html>
