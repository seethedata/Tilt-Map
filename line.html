<!DOCTYPE html>
<meta charset="utf-8">
<style>

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

</style>

<script src="js/d3.v4.min.js"></script>
<script>
/*<svg width="960" height="500"></svg>*/
var tiltAPI="http://tilt.cfapps.io/safe_dump?";
var min_ts=0;
var refreshInterval=100; // in milliseconds
var sampleWidth=30000 / refreshInterval; // 30 seconds of graphs (30000 milliseconds broken up into refreshInterval number of points)


var margin = {top: 20, right: 20, bottom: 20, left: 40},
    width = 960- margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;
	
var allData=[];

var x = d3.scaleLinear()
    .domain([0, sampleWidth - 1])
    .range([0, width]);

var y = d3.scaleLinear()
    .domain([-180, 180])
    .range([height, 0]);

var line = d3.line()
    .x(function(d, i) {return x(i); })
    .y(function(d, i) {console.log(d);return y(d);});




function updateGraphs() {
	var url=tiltAPI + "min_score="+min_ts + "&latest=1";
	d3.json(url, function plotDevices(error, devData) {
		if (error) return console.warn(error);
		min_ts=devData.timestamp;
	
		var nextData=devData.data;	
		
		for (var i=0; i < nextData.length ; i++)  {
			var j=JSON.parse(nextData[i].replace(/"{/g,"{").replace(/}"/g,"}").replace(/\\"/g,"\""));
			var found=false;

			for (var k=0; k < allData.length;k++) {
				if (allData[k].devid == j.devid) {
					allData[k].data.push(j.TiltFB);
					if (allData[k].data.length > sampleWidth) {
						allData[k].data.shift();
					}
					found=true;
					break;
				} else {
					continue;
				}
			}
			
			if (! found) {
				allData.push({"devid" : j.devid, "data" : [0,j.TiltFB]});
			}
		}

		var svg=d3.select("body").selectAll("svg").data(allData);

		var groups=svg.enter()
			.append("svg")
			.attr("id",function(d) {return d.devid;})
			.attr("width",960)
			.attr("height", 500)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
				
		groups
			.append("defs")
							.append("clipPath")
								.attr("id", "clip")
								.append("rect")
									.attr("width", width)
									.attr("height", height)
									.attr("fill","none");
	
		groups
			.append("g")
				.attr("class", "axis axis--y")
				.call(d3.axisLeft(y));
				
		groups
			.append("g")
			.attr("clip-path", "url(#clip)")
			.attr("id","clip-path")
			.append("path")
					.attr("class", "line")
					.attr("id",function(d) { return "lineFor-" + d.devid;});
		
		svg.exit().remove();
		

		for (k=0; k < allData.length; k++) {
			var thisLine=d3.select("#lineFor-" + allData[k].devid).datum(allData[k].data);
			thisLine
				.attr("d", line)
				.attr("transform", null)
				.transition()
					.duration(500)
					.ease(d3.easeLinear);
				
			  // Slide it to the left.
			 thisLine.selectAll(".line").transition()
				  .attr("transform", "translate(" + x(-1) + ",0)");
		}

	});
}

setInterval(updateGraphs,refreshInterval);

</script>

